# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      frontendTag:
        description: "Test"
        required: false
        default: 'stable'
      backendTag:
        description: "Test"
        required: false
        default: 'develop'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Generate Application Tag
        run: |
          # Frontend
          if [ -z ${{ github.event.inputs.frontendTag }} ]; then
             echo "FRONTEND_TAG=notstable" >> "$GITHUB_ENV"
          else
             echo "FRONTEND_TAG=${{ github.event.inputs.frontendTag }}" >> "$GITHUB_ENV"
          fi
          # Backend
          if [ -z ${{ github.event.inputs.backendTag }} ]; then
             echo "BACKEND_TAG=notdevelop" >> "$GITHUB_ENV"
          else
             echo "BACKEND_TAG=${{ github.event.inputs.backendTag }}" >> "$GITHUB_ENV"
          fi

      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      # Runs a set of commands using the runners shell

      - name: create file
        id: create-file
        run: |
          pwd
          touch testfile
          echo "testtest" > testfile
          #cp testfile /home/runner/work/test-repo/test-repo/
          #cat /home/runner/work/_temp/_github_home
      
      - name: Run a multi-line script
        uses: docker://ubuntu:latest
        with:
          args: cat /github/workspace/testfile

      - name: push tag
        run: |
          # checkout時のPATのrepoのFullコントロールで許可する
          # checkoutに必要
          git fetch origin develop
          # tag付けに必要
          git checkout develop
          git tag test-$(date +%Y%m%d_%H%M%S) develop
          git push origin test-$(date +%Y%m%d_%H%M%S)

      - name: cheout remote tag
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}
          repository: apc-jnytnai0613/oidc-test
          path: oidc-test

      - name: push remote tag
        run: |
          cd oidc-test
          # checkout時のPATのrepoのFullコントロールで許可する
          # checkoutに必要
          git fetch origin develop
          # tag付けに必要
          git checkout develop
          git tag test-$(date +%Y%m%d_%H%M%S) develop
          git push origin test-$(date +%Y%m%d_%H%M%S)

  # This workflow contains a single job called "build"
  echo:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: echo env
        run: |
          echo ${{ env.FRONTEND_TAG }}
          echo ${{ env.BACKEND_TAG }}
